# Sussurro Architecture

Sussurro is designed as a modular pipeline that processes audio input into refined text output. This document details the internal components and data flow.

## High-Level Pipeline

The data flow follows this sequence:

1.  **Hotkey Trigger**: User presses the configured hotkey (default: `Ctrl+Shift+Space`).
2.  **Audio Capture**: Microphone input is recorded until the hotkey is released or silence is detected.
3.  **ASR (Automatic Speech Recognition)**: Raw audio is converted to text using **Whisper.cpp**.
4.  **LLM Cleanup**: The raw transcription is processed by a Large Language Model (**Qwen 3 Sussurro**) to remove artifacts, filler words, and apply grammar corrections.
5.  **Clipboard and Text Injection**: The cleaned text is written to the clipboard and pasted into the active application.

---

## Components

### 1. Audio Engine (`internal/audio`)
- **Library**: `github.com/gen2brain/malgo` (MiniAudio bindings).
- **Function**: Captures raw PCM audio data.
- **Config**: Sample rate (16kHz standard for Whisper), bit depth, and channels.

### 2. ASR Engine (`internal/asr`)
- **Library**: `github.com/ggerganov/whisper.cpp` (Go bindings).
- **Model**: `ggml-small.bin` (default).
- **Role**: Performs the initial speech-to-text conversion. It produces a raw transcription that may contain stuttering, filler words ("umm", "ah"), or lack proper punctuation.

### 3. LLM Engine (`internal/llm`)
- **Library**: `github.com/AshkanYarmoradi/go-llama.cpp`.
- **Model**: `Qwen 3 Sussurro` (Quantized Q4_K_M).
- **Prompt Engineering**:
    - Uses a specific system prompt to instruct the model to act as a "text cleanup assistant".
    - Enforces rules: remove filler words, fix grammar, output *only* corrected text.
    - **Self-Correction Handling**: Specifically instructed to handle "speech repairs" (e.g., "I want blue... no red" -> "I want red").
- **Post-Processing**:
    - **Thought Removal**: Uses Regex to strip `<think>...</think>` tags generated by the Qwen model's reasoning process.
    - **Anti-Hallucination**: Validates output against the input to ensure the model hasn't hallucinated new information (length checks, keyword presence).

### 4. Context Provider (`internal/context`)
- **Role**: Detects the currently active application.
- **Platform**: Currently specialized for macOS (using Accessibility APIs via JXA/AppleScript or native calls).
- **Usage**: Can be used to tailor prompts based on the app (e.g., "Code mode" for VS Code vs. "Email mode" for Mail).

### 5. Clipboard (`internal/clipboard`)
- **Role**: Stores the cleaned text so it can be pasted reliably.

### 6. Input Injector (`internal/injection`)
- **Library**: `github.com/micmonay/keybd_event`.
- **Role**: Triggers the paste shortcut to insert the final text.
